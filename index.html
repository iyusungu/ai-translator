<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>中日全能翻譯</title>
    <style>
        :root {
            --bg-color: #131314;
            --header-bg: #1e1f20;
            --user-bubble: #2d2e30;
            --text-color: #e3e3e3;
            --sub-text: #9ca0a6;
            --input-bg: #2a2b2d;
            --accent-color: #a8c7fa;
            --sidebar-bg: #1a1a1c;
            --sidebar-width: 260px;
            --border-color: #333;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        header {
            background-color: var(--header-bg);
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            display: flex; justify-content: space-between; align-items: center;
            z-index: 9999; border-bottom: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        #menu-btn { background: transparent; border: none; color: var(--text-color); padding: 4px; cursor: pointer; }
        #menu-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #header-info { display: flex; flex-direction: column; }
        #app-title { font-size: 16px; font-weight: 600; letter-spacing: 0.5px; }
        #model-indicator { font-size: 10px; color: var(--accent-color); margin-top: 2px; font-family: monospace; }
        #api-key-btn { font-size: 12px; background: transparent; border: 1px solid #555; color: var(--sub-text); padding: 4px 10px; border-radius: 12px; cursor: pointer; }

        /* Sidebar */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        #overlay.active { opacity: 1; pointer-events: auto; }
        #sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100%; background-color: var(--sidebar-bg); z-index: 10001; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding-top: max(20px, env(safe-area-inset-top)); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        #sidebar.active { transform: translateX(0); }

        .sidebar-section { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .sidebar-label { font-size: 12px; color: var(--sub-text); margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }

        /* Strategy Switcher */
        .strategy-switch { display: flex; background: #000; border-radius: 8px; padding: 3px; }
        .strategy-btn { flex: 1; background: transparent; border: none; color: #666; padding: 8px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .strategy-btn.active { background: #333; color: var(--text-color); font-weight: bold; }

        /* Navigation Menu */
        .nav-container { padding: 10px 0; overflow-y: auto; flex: 1; }
        .nav-header { padding: 15px 20px 5px 20px; font-size: 13px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .nav-item { padding: 12px 20px; cursor: pointer; font-size: 15px; color: #ccc; transition: background 0.2s; display: flex; align-items: center; border-left: 3px solid transparent; }
        .nav-item.sub { padding-left: 35px; font-size: 14px; color: #aaa; }
        .nav-item:hover, .nav-item:active { background-color: #2a2a2a; }
        .nav-item.selected { background-color: #2d2e30; color: var(--accent-color); font-weight: 500; border-left-color: var(--accent-color); }

        /* Model Selector (Bottom) */
        .model-selector-section { margin-top: auto; border-top: 1px solid var(--border-color); padding: 15px 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); background: #151516; }
        .model-select { width: 100%; background: #000; color: #ccc; border: 1px solid #444; padding: 10px; border-radius: 8px; outline: none; font-size: 12px; appearance: none; }
        .model-select:focus { border-color: #666; }

        /* View Containers */
        .view-container { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; }
        .view-container.active { display: flex; }

        /* Chat View */
        #chat-scroll-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; -webkit-overflow-scrolling: touch; }
        .message-row { display: flex; flex-direction: column; width: 100%; }
        .message { max-width: 88%; line-height: 1.6; font-size: 16px; word-wrap: break-word; position: relative; }
        .user-row { align-items: flex-end; }
        .user-bubble { background-color: var(--user-bubble); color: var(--text-color); padding: 12px 18px; border-radius: 20px; border-bottom-right-radius: 4px; }
        .ai-row { align-items: flex-start; }
        .ai-bubble { background-color: transparent; color: var(--text-color); padding: 0 4px; }
        .ai-label { font-size: 11px; color: var(--sub-text); margin-bottom: 4px; margin-left: 4px; font-weight: 600; }
        
        .typing-indicator { display: inline-flex; align-items: center; gap: 5px; padding: 12px 16px; background-color: #2a2b2d; border-radius: 18px; border-bottom-left-radius: 4px; width: fit-content; margin-top: 2px; }
        .typing-dot { width: 6px; height: 6px; background-color: #888; border-radius: 50%; animation: typing-wave 1.3s linear infinite; }
        .typing-dot:nth-child(2) { animation-delay: -1.1s; }
        .typing-dot:nth-child(3) { animation-delay: -0.9s; }
        @keyframes typing-wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        .system-note { align-self: flex-start; background-color: var(--input-bg); border-radius: 12px; font-size: 14px; color: #ccc; padding: 14px; margin-top: 5px; border: 1px solid var(--border-color); width: 95%; }
        .note-title { font-size: 11px; color: #888; margin-bottom: 6px; font-weight: bold; letter-spacing: 0.5px; }

        #action-buttons { display: flex; padding: 5px 15px 15px; gap: 8px; overflow-x: auto; min-height: 40px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #action-buttons.visible { opacity: 1; pointer-events: auto; }
        .action-btn { padding: 6px 14px; background-color: var(--input-bg); border: 1px solid #444; border-radius: 16px; color: #ccc; font-size: 13px; white-space: nowrap; cursor: pointer; }
        .action-btn:active { background-color: #444; }

        #chat-input-wrapper { background-color: var(--bg-color); padding: 10px 15px; padding-bottom: max(20px, env(safe-area-inset-bottom)); z-index: 100; }
        #chat-input-box { background-color: var(--input-bg); border-radius: 24px; display: flex; align-items: center; padding: 8px 8px 8px 16px; border: 1px solid var(--border-color); }
        #chat-message-input { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; height: 24px; }
        #send-btn { background-color: #e3e3e3; color: #000; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: opacity 0.2s; }
        #send-btn svg { width: 18px; height: 18px; fill: black; }
        #send-btn:disabled { opacity: 0.3; }

        /* Email View */
        #email-view { padding: 15px; gap: 10px; overflow-y: auto; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .email-top-split { display: flex; gap: 10px; flex: 1; min-height: 200px; }
        .email-left-col { flex: 2; display: flex; flex-direction: column; background: var(--input-bg); border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); }
        .email-right-col { flex: 1; display: flex; flex-direction: column; background: var(--input-bg); border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); }
        .email-bottom-row { flex: 1; display: flex; flex-direction: column; background: var(--input-bg); border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); min-height: 200px; }
        .section-header { font-size: 11px; color: var(--sub-text); margin-bottom: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; }
        textarea.email-input { width: 100%; flex: 1; background: transparent; border: none; color: var(--text-color); font-size: 15px; line-height: 1.5; resize: none; outline: none; font-family: inherit; }
        textarea.email-prompt-input { width: 100%; flex: 1; background: #131314; border: 1px solid #444; border-radius: 8px; padding: 8px; color: #ccc; font-size: 13px; resize: none; outline: none; margin-bottom: 8px; }
        .ai-gen-btn { width: 100%; background: var(--text-color); color: black; border: none; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .ai-gen-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .tone-switcher { display: flex; background: #131314; border-radius: 6px; padding: 2px; }
        .tone-btn { background: transparent; border: none; color: #666; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 4px; }
        .tone-btn.active { background: #333; color: white; }
        #btn-email-translate { margin-top: 10px; width: 100%; background: #333; color: white; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        #btn-email-translate:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 20000; justify-content: center; align-items: center; }
        .modal-content { background: #1e1f20; padding: 25px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center; border: 1px solid #444; }
        .modal-input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #131314; color: white; font-size: 16px; outline: none; }
        .modal-save { background: #e3e3e3; color: black; padding: 12px; border: none; border-radius: 8px; font-weight: 600; width: 100%; font-size: 16px; cursor: pointer; }
        .modal-cancel { margin-top: 15px; background: transparent; color: #888; border: none; font-size: 14px; cursor: pointer; }

    </style>
</head>
<body>

<header>
    <div class="header-left">
        <button id="menu-btn"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
        <div id="header-info">
            <div id="app-title">對話翻譯</div>
            <div id="model-indicator">初始化中...</div>
        </div>
    </div>
    <button id="api-key-btn">Key</button>
</header>

<div id="overlay"></div>
<div id="sidebar">
    <div class="sidebar-section">
        <div class="sidebar-label">連線模式</div>
        <div class="strategy-switch">
            <button class="strategy-btn active" id="btn-strategy-speed" onclick="setStrategy('speed')">即時</button>
            <button class="strategy-btn" id="btn-strategy-quality" onclick="setStrategy('quality')">專業</button>
        </div>
    </div>

    <div class="nav-container">
        <div class="nav-header">對話翻譯</div>
        <div class="nav-item sub selected" id="nav-chat-casual" onclick="switchMode('chat', 'casual')">口語模式</div>
        <div class="nav-item sub" id="nav-chat-business" onclick="switchMode('chat', 'business')">商業模式</div>
        <div class="nav-item sub" id="nav-chat-custom" onclick="switchMode('chat', 'custom')">自訂模式</div>

        <div class="nav-header" style="margin-top: 10px;">工具</div>
        <div class="nav-item" id="nav-email" onclick="switchMode('email')">信件撰寫</div>
    </div>

    <div class="model-selector-section">
        <div class="sidebar-label">指定模型 (強制)</div>
        <select id="model-selector" class="model-select">
            <option value="">自動 (依策略)</option>
            </select>
    </div>
</div>

<div id="chat-view" class="view-container active">
    <div id="chat-scroll-area">
        <div class="message-row ai-row">
            <div class="ai-label">AI</div>
            <div class="message ai-bubble">歡迎。請輸入中文或日文。</div>
        </div>
    </div>
    <div id="action-buttons">
        <button class="action-btn" id="btn-furigana">顯示假名</button>
        <button class="action-btn" id="btn-grammar">文法解說</button>
    </div>
    <div id="chat-input-wrapper">
        <div id="chat-input-box">
            <input type="text" id="chat-message-input" placeholder="輸入訊息..." autocomplete="off">
            <button id="send-btn"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
        </div>
    </div>
</div>

<div id="email-view" class="view-container">
    <div class="email-top-split">
        <div class="email-left-col">
            <div class="section-header">內容草稿</div>
            <textarea id="email-input-text" class="email-input" placeholder="在此輸入內容..."></textarea>
        </div>
        <div class="email-right-col">
            <div class="section-header">AI 指令</div>
            <textarea id="email-ai-prompt" class="email-prompt-input" placeholder="例: 委婉拒絕..."></textarea>
            <button class="ai-gen-btn" id="btn-email-gen">生成</button>
        </div>
    </div>
    <div class="email-bottom-row">
        <div class="section-header">
            <span>翻譯結果</span>
            <div class="tone-switcher">
                <button class="tone-btn" id="tone-casual" onclick="setEmailTone('casual')">朋友</button>
                <button class="tone-btn active" id="tone-business" onclick="setEmailTone('business')">商業</button>
            </div>
        </div>
        <textarea id="email-output-text" class="email-input" placeholder="結果顯示於此..." readonly></textarea>
        <button id="btn-email-translate">翻譯信件</button>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#eee; margin:0;">Settings</h3>
        <p style="font-size:12px; color:#888;">Google API Key</p>
        <input type="password" id="api-key-input" class="modal-input" placeholder="AIza...">
        <button class="modal-save" id="save-key-btn">Confirm</button>
        <button class="modal-cancel" onclick="document.getElementById('settings-modal').style.display='none'">Cancel</button>
    </div>
</div>

<div id="custom-mode-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#eee; margin:0;">自訂模式</h3>
        <input type="text" id="custom-prompt-input" class="modal-input" placeholder="輸入翻譯風格要求...">
        <button class="modal-save" id="save-custom-btn">設定</button>
        <button class="modal-cancel" onclick="document.getElementById('custom-mode-modal').style.display='none'">Cancel</button>
    </div>
</div>

<script>
    window.onerror = function(msg, url, line) { alert("Error: " + msg); return false; };

    // State
    let apiKey = "";
    let modelStrategy = "speed"; // 'speed' or 'quality'
    let currentModel = "";
    let currentModelDisplayName = ""; 
    let forcedModel = ""; // User selected forced model
    
    // Chat State
    let chatMode = "casual";
    let customPrompt = "";
    let lastChatJapanese = "";

    // Email State
    let emailTone = "business"; 

    // Models Priority Lists (Updated: 2.0 Flash First)
    const SPEED_MODELS = [
        "gemini-2.0-flash",             // Absolute Speed Priority
        "gemini-2.0-flash-001",
        "gemini-2.5-flash",             // Newer but maybe slightly slower?
        "gemini-2.0-flash-lite",
        "gemini-flash-latest"
    ];
    const QUALITY_MODELS = [
        "gemini-2.5-pro",
        "gemini-2.0-pro-exp-02-05",
        "gemini-1.5-pro",
        "gemini-1.5-pro-latest"
    ];

    // Full Supported List for Force Selection
    const ALL_SUPPORTED_MODELS = [
        "gemini-2.5-flash",
        "gemini-2.5-pro",
        "gemini-2.0-flash",
        "gemini-2.0-flash-001",
        "gemini-2.0-flash-lite-001",
        "gemini-2.0-flash-lite",
        "gemini-2.0-flash-lite-preview-02-05",
        "gemini-2.0-flash-lite-preview",
        "gemini-flash-latest",
        "gemini-flash-lite-latest",
        "gemini-pro-latest",
        "gemini-2.5-flash-lite",
        "gemini-2.5-flash-preview-09-2025",
        "gemini-2.5-flash-lite-preview-09-2025",
        "gemini-robotics-er-1.5-preview"
    ];

    document.addEventListener('DOMContentLoaded', function() {
        try { apiKey = localStorage.getItem("google_api_key") || ""; } catch (e) {}

        // DOM Elements
        const modal = document.getElementById('settings-modal');
        const customModal = document.getElementById('custom-mode-modal');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const appTitle = document.getElementById('app-title');
        const modelIndicator = document.getElementById('model-indicator');
        const modelSelector = document.getElementById('model-selector');
        
        // Populate Model Selector
        ALL_SUPPORTED_MODELS.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.innerText = m;
            modelSelector.appendChild(opt);
        });

        // Initialize
        updateModelIndicator();
        if (!apiKey) {
            setTimeout(() => modal.style.display = 'flex', 500);
        } else {
            detectBestModel();
        }

        // --- Event Listeners ---
        document.getElementById('menu-btn').addEventListener('click', () => { sidebar.classList.add('active'); overlay.classList.add('active'); });
        overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });

        document.getElementById('api-key-btn').addEventListener('click', () => { modal.style.display = 'flex'; document.getElementById('api-key-input').value = apiKey; });
        document.getElementById('save-key-btn').addEventListener('click', () => {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem("google_api_key", apiKey);
                modal.style.display = 'none';
                currentModel = ""; 
                detectBestModel();
                alert("Key Saved");
            }
        });

        // Model Selector Change
        modelSelector.addEventListener('change', (e) => {
            forcedModel = e.target.value;
            currentModel = ""; // Reset current
            detectBestModel(); // Re-detect (will prioritize forced)
        });

        document.getElementById('send-btn').addEventListener('click', sendChatMessage);
        document.getElementById('chat-message-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChatMessage(); });
        document.getElementById('btn-furigana').addEventListener('click', requestChatFurigana);
        document.getElementById('btn-grammar').addEventListener('click', requestChatGrammar);
        document.getElementById('save-custom-btn').addEventListener('click', () => {
            customPrompt = document.getElementById('custom-prompt-input').value;
            switchMode('chat', 'custom');
            customModal.style.display = 'none';
        });

        document.getElementById('btn-email-gen').addEventListener('click', generateEmailDraft);
        document.getElementById('btn-email-translate').addEventListener('click', translateEmail);

        // --- Global Functions ---

        window.setStrategy = function(strategy) {
            modelStrategy = strategy;
            // Disable forced model if strategy clicked (optional UX choice, keeping forced is also valid)
            // Let's keep forced model if selected, otherwise switch strategy
            if (!forcedModel) {
                currentModel = ""; 
                detectBestModel();
            }
            
            document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-strategy-${strategy}`).classList.add('active');
            
            sidebar.classList.remove('active'); 
            overlay.classList.remove('active');
            updateModelIndicator();
        }

        window.switchMode = function(type, mode) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));

            if (type === 'email') {
                document.getElementById('email-view').classList.add('active');
                document.getElementById('nav-email').classList.add('selected');
                appTitle.innerText = "信件撰寫";
            } else {
                clearEmailData();
                document.getElementById('chat-view').classList.add('active');
                document.getElementById(`nav-chat-${mode}`).classList.add('selected');
                
                if (mode === 'custom' && !customPrompt) {
                    customModal.style.display = 'flex';
                } else {
                    chatMode = mode;
                    let titleMap = { 'casual': '口語模式', 'business': '商業模式', 'custom': '自訂模式' };
                    appTitle.innerText = titleMap[mode];
                    addChatMessage(`已切換至：${titleMap[mode]}`, 'ai');
                    sidebar.classList.remove('active'); overlay.classList.remove('active');
                }
            }
            
            if (type === 'email') {
                sidebar.classList.remove('active'); overlay.classList.remove('active');
            }
        }

        function clearEmailData() {
            document.getElementById('email-input-text').value = "";
            document.getElementById('email-ai-prompt').value = "";
            document.getElementById('email-output-text').value = "";
        }

        window.setEmailTone = function(tone) {
            emailTone = tone;
            document.getElementById('tone-casual').classList.toggle('active', tone === 'casual');
            document.getElementById('tone-business').classList.toggle('active', tone === 'business');
        }

        function updateModelIndicator() {
            if (forcedModel) {
                modelIndicator.innerText = `強制指定 (${forcedModel})`;
                return;
            }
            const strategyName = modelStrategy === 'speed' ? '即時' : '專業';
            const detail = currentModelDisplayName ? ` (${currentModelDisplayName})` : " (偵測中...)";
            modelIndicator.innerText = `${strategyName}${detail}`;
        }

        // --- Model Detection ---
        async function detectBestModel() {
            // If user forced a model, use it immediately
            if (forcedModel) {
                currentModel = forcedModel;
                currentModelDisplayName = forcedModel;
                updateModelIndicator();
                return forcedModel;
            }

            if (currentModel) {
                updateModelIndicator();
                return currentModel;
            }
            
            // Standard Strategy Logic
            const primaryList = modelStrategy === 'speed' ? SPEED_MODELS : QUALITY_MODELS;
            const secondaryList = modelStrategy === 'speed' ? QUALITY_MODELS : SPEED_MODELS;
            const allCandidates = [...primaryList, ...secondaryList];

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                if (!data.models) { modelIndicator.innerText = "連線錯誤"; return null; }

                const availableNames = data.models.map(m => m.name.replace("models/", ""));
                
                for (const pref of allCandidates) {
                    if (availableNames.includes(pref)) {
                        currentModel = pref;
                        currentModelDisplayName = pref;
                        updateModelIndicator();
                        return pref;
                    }
                }
                // Fallback
                currentModel = "gemini-1.5-flash";
                currentModelDisplayName = "gemini-1.5-flash";
                updateModelIndicator();
                return currentModel;
            } catch(e) { 
                modelIndicator.innerText = "API Error";
                return null; 
            }
        }

        // --- Chat Logic ---
        async function sendChatMessage() {
            const input = document.getElementById('chat-message-input');
            const text = input.value.trim();
            if (!text) return;
            if (!apiKey) return alert("Please set API Key");

            addChatMessage(text, 'user');
            input.value = "";
            
            const btn = document.getElementById('send-btn');
            btn.style.opacity = 0.5; btn.disabled = true;

            if (containsJapanese(text)) {
                lastChatJapanese = text;
                toggleChatButtons(true);
            } else {
                toggleChatButtons(false);
            }

            const model = await detectBestModel();
            if(!model) { addChatMessage("Model Error", 'ai'); return; }

            const typingId = addTypingIndicator();

            let sysPrompt = "你是一個中日口譯員。規則：只回傳翻譯結果。";
            if (chatMode === 'business') sysPrompt += "請使用標準的商業敬語(丁寧語/尊敬語/謙讓語)。";
            else if (chatMode === 'custom') sysPrompt += `請依照此要求翻譯：${customPrompt}`;
            else sysPrompt += "請使用有禮貌的自然口語，不要濫用「ね」。";
            
            sysPrompt += " 若輸入中文翻日文，若輸入日文翻繁體中文(台灣口語)。";

            const result = await callGemini(model, sysPrompt + "\n\nInput: " + text);
            
            removeTypingIndicator(typingId);
            btn.style.opacity = 1; btn.disabled = false;

            if (result) {
                addChatMessage(result, 'ai');
                if (containsJapanese(result)) {
                    lastChatJapanese = result;
                    toggleChatButtons(true);
                }
            }
        }

        // --- Email Logic ---
        async function generateEmailDraft() {
            const prompt = document.getElementById('email-ai-prompt').value.trim();
            if (!prompt) return alert("請輸入提示");
            if (!apiKey) return alert("API Key Missing");

            const model = await detectBestModel();
            const btn = document.getElementById('btn-email-gen');
            const originalText = btn.innerText;
            btn.innerText = "草稿生成中..."; btn.disabled = true; btn.style.opacity = 0.6;

            const sysPrompt = `你是一個專業的信件撰寫助手。請根據使用者的提示，撰寫一封完整的信件草稿。語言取決於提示內容(若無指定則預設為中文)。`;
            
            const result = await callGemini(model, sysPrompt + "\n\n提示: " + prompt);
            btn.innerText = originalText; btn.disabled = false; btn.style.opacity = 1;

            if (result) {
                document.getElementById('email-input-text').value = result;
            }
        }

        async function translateEmail() {
            const text = document.getElementById('email-input-text').value.trim();
            if (!text) return alert("請先輸入信件內容");
            if (!apiKey) return alert("API Key Missing");

            const model = await detectBestModel();
            const btn = document.getElementById('btn-email-translate');
            btn.innerText = "翻譯中..."; btn.disabled = true;

            const toneInstruction = emailTone === 'business' ? "極度正式、商業禮儀、敬語" : "輕鬆、像朋友一樣的口吻";
            const sysPrompt = `你是一個信件翻譯機。
            1. 自動偵測輸入語言。若是中文則翻日文，若是日文則翻中文。
            2. 語氣要求：${toneInstruction}。
            3. 保持信件格式完整。
            4. 只回傳翻譯後的信件內容，不要解釋。`;

            const result = await callGemini(model, sysPrompt + "\n\n信件內容:\n" + text);
            btn.innerText = "翻譯信件"; btn.disabled = false;

            if (result) {
                document.getElementById('email-output-text').value = result;
            }
        }

        // --- API & Helper ---
        async function callGemini(model, content) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: content }] }] })
                });
                const data = await res.json();
                if(data.error) { alert(data.error.message); return null; }
                return data.candidates[0].content.parts[0].text;
            } catch(e) { alert("Connection Error"); return null; }
        }

        function addChatMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message-row ${role}-row`;
            div.innerHTML = role === 'ai' ? 
                `<div class="ai-label">AI</div><div class="message ai-bubble">${text.replace(/\n/g, '<br>')}</div>` :
                `<div class="message user-bubble">${text.replace(/\n/g, '<br>')}</div>`;
            document.getElementById('chat-scroll-area').appendChild(div);
            document.getElementById('chat-scroll-area').scrollTop = 100000;
        }

        function addTypingIndicator() {
            const id = "typing-" + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "message-row ai-row";
            div.innerHTML = `
                <div class="ai-label">AI</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            document.getElementById('chat-scroll-area').appendChild(div);
            document.getElementById('chat-scroll-area').scrollTop = 100000;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        async function requestChatFurigana() {
            if(!lastChatJapanese) return;
            const model = await detectBestModel();
            const typingId = addTypingIndicator(); 
            const res = await callGemini(model, "請標註假名(Furigana)：" + lastChatJapanese);
            removeTypingIndicator(typingId);
            if(res) addNote("假名標註", res);
        }

        async function requestChatGrammar() {
            if(!lastChatJapanese) return;
            const model = await detectBestModel();
            const typingId = addTypingIndicator(); 
            const res = await callGemini(model, "請用繁體中文解說此日文文法與語氣：" + lastChatJapanese);
            removeTypingIndicator(typingId);
            if(res) addNote("文法解說", res.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/^\s*-\s/gm, '• '));
        }

        function addNote(title, text) {
            const div = document.createElement('div');
            div.className = "message-row ai-row";
            div.innerHTML = `<div class="ai-label">Helper</div><div class="system-note"><div class="note-title">${title}</div><div>${text.replace(/\n/g, '<br>')}</div></div>`;
            document.getElementById('chat-scroll-area').appendChild(div);
            document.getElementById('chat-scroll-area').scrollTop = 100000;
        }

        function toggleChatButtons(show) {
            const el = document.getElementById('action-buttons');
            if(show) el.classList.add('visible'); else el.classList.remove('visible');
        }

        function containsJapanese(text) { return /[\u3040-\u309F\u30A0-\u30FF]/.test(text); }
    });
</script>
</body>
</html>
